services:
  octopal:
    build: .
    volumes:
      - vault:/vault
      - octopal-config:/root/.octopal
      - shared:/shared
    environment:
      - OCTOPAL_VAULT_PATH=/vault
      - OCTOPAL_VAULT_REMOTE=${VAULT_REMOTE}
      - OCTOPAL_VAULT_BASE_URL=${VAULT_BASE_URL:-http://localhost:8443}
      - OCTOPAL_VAULT_PATH_PREFIX=/home/coder/vault
      - OCTOPAL_SERVER_PORT=3847
      - OCTOPAL_PASSWORD_HASH=${OCTOPAL_PASSWORD_HASH}
      - OCTOPAL_TOKEN_SECRET=${OCTOPAL_TOKEN_SECRET}
      - GH_TOKEN=${GH_TOKEN}
      - GIT_USER_NAME=${GIT_USER_NAME:-}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-}
      - OCTOPAL_DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      - OCTOPAL_DISCORD_ALLOWED_USERS=${DISCORD_ALLOWED_USERS:-}
      - OCTOPAL_DISCORD_CHANNELS=${DISCORD_CHANNELS:-}
    ports:
      - "${OCTOPAL_PORT:-3847}:3847"
    networks:
      - octopal-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3847/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Provisions a daemon service token for code-server's extension
  token-init:
    build: .
    entrypoint: /app/scripts/provision-token.sh
    depends_on:
      octopal:
        condition: service_healthy
    environment:
      - OCTOPAL_PASSWORD=${OCTOPAL_PASSWORD}
    volumes:
      - shared:/shared
    networks:
      - octopal-net

  code-server:
    build:
      context: .
      dockerfile: Dockerfile.code-server
    depends_on:
      token-init:
        condition: service_completed_successfully
    volumes:
      - vault:/home/coder/vault
      - shared:/shared:ro
      - cs-data:/home/coder/.local/share/code-server
    environment:
      - PASSWORD=${CODE_SERVER_PASSWORD}
      - OCTOPAL_TOKEN_FILE=/shared/octopal-token
      - OCTOPAL_DAEMON_URL=ws://octopal:3847/ws
    command:
      - --bind-addr=0.0.0.0:8443
      - --auth=password
      - --disable-telemetry
      - --enable-proposed-api=octopal.octopal-vscode
      - /home/coder/vault
    ports:
      - "${CODE_SERVER_PORT:-8443}:8443"
    networks:
      - octopal-net
    restart: unless-stopped

volumes:
  vault:
  octopal-config:
  cs-data:
  shared:

networks:
  octopal-net:
